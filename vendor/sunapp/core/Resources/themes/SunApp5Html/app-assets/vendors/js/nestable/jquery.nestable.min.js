!function(d,h,c,i){function l(t,e){this.w=d(c),this.el=d(t),(e=e||s).rootClass!==i&&"dd"!==e.rootClass&&(e.listClass=e.listClass||e.rootClass+"-list",e.itemClass=e.itemClass||e.rootClass+"-item",e.dragClass=e.dragClass||e.rootClass+"-dragel",e.handleClass=e.handleClass||e.rootClass+"-handle",e.collapsedClass=e.collapsedClass||e.rootClass+"-collapsed",e.placeClass=e.placeClass||e.rootClass+"-placeholder",e.noDragClass=e.noDragClass||e.rootClass+"-nodrag",e.noChildrenClass=e.noChildrenClass||e.rootClass+"-nochildren",e.emptyClass=e.emptyClass||e.rootClass+"-empty"),this.options=d.extend({},s,e),this.options.json!==i&&this._build(),this.init()}var n="ontouchstart"in c,p=function(){var t=c.createElement("div"),e=c.documentElement;if(!("pointerEvents"in t.style))return!1;t.style.pointerEvents="auto",t.style.pointerEvents="x",e.appendChild(t);var s=h.getComputedStyle&&"auto"===h.getComputedStyle(t,"").pointerEvents;return e.removeChild(t),!!s}(),s={contentCallback:function(t){return t.content||t.id},listNodeName:document.querySelector("tbody.dd-list")?"tbody":"ol",itemNodeName:document.querySelector("tbody.dd-list")?"tr":"li",handleNodeName:"div",contentNodeName:"span",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",contentClass:"dd-content",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",noChildrenClass:"dd-nochildren",emptyClass:"dd-empty",expandBtnHTML:'<button class="dd-expand" data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button class="dd-collapse" data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,fixedDepth:!1,fixed:!1,includeContent:!1,scroll:!1,scrollSensitivity:1,scrollSpeed:5,scrollTriggers:{top:40,left:40,right:-40,bottom:-40},effect:{animation:"none",time:"slow"},callback:function(t,e,s){},onDragStart:function(t,e,s){},beforeDragStop:function(t,e,s){},listRenderer:function(t,e){var s="<"+e.listNodeName+' class="'+e.listClass+'">';return(s+=t)+("</"+e.listNodeName)+">"},itemRenderer:function(t,e,s,i,o){t=d.map(t,function(t,e){return" "+e+'="'+t+'"'}).join(" "),t="<"+i.itemNodeName+t+">";return t+="<"+i.handleNodeName+' class="'+i.handleClass+'">',t+="<"+i.contentNodeName+' class="'+i.contentClass+'">',t+=e,t+="</"+i.contentNodeName+">",t+="</"+i.handleNodeName+">",(t+=s)+("</"+i.itemNodeName)+">"}};l.prototype={init:function(){var i=this;i.reset(),i.el.data("nestable-group",this.options.group),i.placeEl=d('<div class="'+i.options.placeClass+'"/>');var t=this.el.find(i.options.itemNodeName);d.each(t,function(t,e){var s=d(e),e=s.parent();i.setParent(s),e.hasClass(i.options.collapsedClass)&&i.collapseItem(e.parent())}),t.length||this.appendEmptyElement(this.el),i.el.on("click","button",function(t){var e;i.dragEl||(t=(e=d(t.currentTarget)).data("action"),e=e.parents(i.options.itemNodeName).eq(0),"collapse"===t&&i.collapseItem(e),"expand"===t&&i.expandItem(e))});function e(t){var e=d(t.target);if(!e.hasClass(i.options.handleClass)){if(e.closest("."+i.options.noDragClass).length)return;e=e.closest("."+i.options.handleClass)}e.length&&!i.dragEl&&(i.isTouch=/^touch/.test(t.type),i.isTouch&&1!==t.touches.length||(t.preventDefault(),i.dragStart(t.touches?t.touches[0]:t)))}function s(t){i.dragEl&&(t.preventDefault(),i.dragMove(t.touches?t.touches[0]:t))}function o(t){i.dragEl&&(t.preventDefault(),i.dragStop(t.touches?t.changedTouches[0]:t))}n&&(i.el[0].addEventListener("touchstart",e,!1),h.addEventListener("touchmove",s,!1),h.addEventListener("touchend",o,!1),h.addEventListener("touchcancel",o,!1)),i.el.on("mousedown",e),i.w.on("mousemove",s),i.w.on("mouseup",o),i.el.bind("destroy-nestable",function(){n&&(i.el[0].removeEventListener("touchstart",e,!1),h.removeEventListener("touchmove",s,!1),h.removeEventListener("touchend",o,!1),h.removeEventListener("touchcancel",o,!1)),i.el.off("mousedown",e),i.w.off("mousemove",s),i.w.off("mouseup",o),i.el.off("click"),i.el.unbind("destroy-nestable"),i.el.data("nestable",null)})},destroy:function(){this.el.trigger("destroy-nestable")},add:function(t){var e="."+this.options.listClass,s=d(this.el).children(e);t.parent_id!==i&&(s=s.find('[data-id="'+t.parent_id+'"]'),delete t.parent_id,0===s.children(e).length&&(s=s.append(this.options.listRenderer("",this.options))),s=s.find(e+":first"),this.setParent(s.parent())),s.append(this._buildItem(t,this.options))},replace:function(t){var e=this._buildItem(t,this.options);this._getItemById(t.id).replaceWith(e)},removeItem:function(t){var e=this.options,s=this.el;(t=t||this).remove();t="."+e.listClass+" ."+e.listClass+":not(:has(*))";d(s).find(t).remove(),d(s).find('[data-action="expand"], [data-action="collapse"]').each(function(){0===d(this).siblings("."+e.listClass).length&&d(this).remove()})},remove:function(t,e){var s=this.options,i=this,o=this._getItemById(t),t=s.effect.animation||"fade",s=s.effect.time||"slow";"fade"===t?o.fadeOut(s,function(){i.removeItem(o)}):this.removeItem(o),e&&e()},removeAll:function(t){function e(){n.each(function(){s.removeItem(d(this))}),o.show(),t&&t()}var s=this,i=this.options,o=s.el.find(i.listNodeName).first(),n=o.children(i.itemNodeName),l=i.effect.animation||"fade",i=i.effect.time||"slow";"fade"===l?o.fadeOut(i,e):e()},_getItemById:function(t){return d(this.el).children("."+this.options.listClass).find('[data-id="'+t+'"]')},_build:function(){var t=this.options.json;"string"==typeof t&&(t=JSON.parse(t)),d(this.el).html(this._buildList(t,this.options))},_buildList:function(t,s){if(!t)return"";var i="",o=this;return d.each(t,function(t,e){i+=o._buildItem(e,s)}),s.listRenderer(i,s)},_buildItem:function(s,t){var e=function(t){delete(t=d.extend({},t)).children,delete t.classes,delete t.content;var i={};return d.each(t,function(t,e){var s;"object"==typeof e&&(e=JSON.stringify(e)),i["data-"+t]=(s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},e+"".replace(/[&<>"']/g,function(t){return s[t]}))}),i}(s);e.class=function(t){var e=s.classes||{};"string"==typeof e&&(e=[e]);e=function(t){var e,s={};for(e in t)s[t[e]]=t[e];return s}(e);return e[t.itemClass]=t.itemClass,d.map(e,function(t){return t}).join(" ")}(t);var i=t.contentCallback(s),o=this._buildList(s.children,t),t=d(t.itemRenderer(e,i,o,t,s));return this.setParent(t),t[0].outerHTML},serialize:function(){var o=this,n=function(t){var i=[];return t.children(o.options.itemNodeName).each(function(){var t=d(this),e=d.extend({},t.data()),s=t.children(o.options.listNodeName);!o.options.includeContent||(t=t.find("."+o.options.contentClass).html())&&(e.content=t),s.length&&(e.children=n(s)),i.push(e)}),i};return n(o.el.find(o.options.listNodeName).first())},asNestedSet:function(){function l(t){return d.isNumeric(t)&&Math.floor(t)==t}var a=this.options,r=[],t=1;return this.el.find(a.listNodeName).first().children(a.itemNodeName).each(function(){t=function t(e,s,i){var o,n=i+1;return 0<d(e).children(a.listNodeName).children(a.itemNodeName).length&&(s++,d(e).children(a.listNodeName).children(a.itemNodeName).each(function(){n=t(d(this),s,n)}),s--),l(o=d(e).attr("data-id"))&&(o=parseInt(o)),l(e=d(e).parent(a.listNodeName).parent(a.itemNodeName).attr("data-id")||"")&&(o=parseInt(e)),o&&r.push({id:o,parent_id:e,depth:s,lft:i,rgt:n}),n+1}(this,0,t)}),r=r.sort(function(t,e){return t.lft-e.lft})},returnOptions:function(){return this.options},serialise:function(){return this.serialize()},toHierarchy:function(t){var o=d.extend({},this.options,t),e=[];return d(this.element).children(o.items).each(function(){var t=function e(t){var s=(d(t).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);if(s){var i={id:s[2]};return 0<d(t).children(o.listType).children(o.items).length&&(i.children=[],d(t).children(o.listType).children(o.items).each(function(){var t=e(this);i.children.push(t)})),i}}(this);e.push(t)}),e},toArray:function(){var l=d.extend({},this.options,this),a=l.startDepthCount||0,r=[],t=2;return this.el.find(this.options.listNodeName).first().children(this.options.itemNodeName).each(function(){t=function t(e,s,i){var o,n=i+1;return 0<e.children(l.options.listNodeName).children(l.options.itemNodeName).length&&(s++,e.children(l.options.listNodeName).children(l.options.itemNodeName).each(function(){n=t(d(this),s,n)}),s--),o=e.data().id,e=s===a+1?l.rootID:e.parent(l.options.listNodeName).parent(l.options.itemNodeName).data().id,o&&r.push({id:o,parent_id:e,depth:s,left:i,right:n}),n+1}(d(this),a+1,t)}),r=r.sort(function(t,e){return t.left-e.left})},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(t){t.removeClass(this.options.collapsedClass)},collapseItem:function(t){t.children(this.options.listNodeName).length&&t.addClass(this.options.collapsedClass)},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(d(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(d(this))})},setParent:function(t){t.is(this.options.itemNodeName)&&t.children(this.options.listNodeName).length&&(t.children("[data-action]").remove(),t.prepend(d(this.options.expandBtnHTML)),t.prepend(d(this.options.collapseBtnHTML)))},unsetParent:function(t){t.removeClass(this.options.collapsedClass),t.children("[data-action]").remove(),t.children(this.options.listNodeName).remove()},dragStart:function(t){var e=this.mouse,s=d(t.target).closest(this.options.itemNodeName),i={top:t.pageY,left:t.pageX},i=this.options.onDragStart.call(this,this.el,s,i);if(void 0===i||!1!==i){this.placeEl.css("height",s.height()),e.offsetX=t.pageX-s.offset().left,e.offsetY=t.pageY-s.offset().top,e.startX=e.lastX=t.pageX,e.startY=e.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=d(c.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",s.outerWidth()),this.setIndexOfItem(s),s.after(this.placeEl),s[0].parentNode.removeChild(s[0]),s.appendTo(this.dragEl),d(c.body).append(this.dragEl),this.dragEl.css({left:t.pageX-e.offsetX,top:t.pageY-e.offsetY});for(var o,n=this.dragEl.find(this.options.itemNodeName),l=0;l<n.length;l++)(o=d(n[l]).parents(this.options.listNodeName).length)>this.dragDepth&&(this.dragDepth=o)}},createSubLevel:function(t,e){var s=d("<"+this.options.listNodeName+"/>").addClass(this.options.listClass);return e&&s.append(e),t.append(s),this.setParent(t),s},setIndexOfItem:function(t,e){(e=e||[]).unshift(t.index()),d(t[0].parentNode)[0]!==this.dragRootEl[0]?this.setIndexOfItem(d(t[0].parentNode),e):this.dragEl.data("indexOfItem",e)},restoreItemAtIndex:function(t,e){for(var s,i=this.el,o=e.length-1,n=0;n<e.length;n++){if(o===parseInt(n))return s=i,l=t,void(0===e[o]?d(s).prepend(l.clone(!0)):d(s.children[e[o]-1]).after(l.clone(!0)));var l=i[0]||i,i=l.children[e[n]]||this.createSubLevel(d(l))}},dragStop:function(t){var e={top:t.pageY,left:t.pageX},s=this.dragEl.data("indexOfItem"),i=this.dragEl.children(this.options.itemNodeName).first();i[0].parentNode.removeChild(i[0]),this.dragEl.remove();t=this.options.beforeDragStop.call(this,this.el,i,this.placeEl.parent());if(void 0!==t&&!1===t){t=this.placeEl.parent();return this.placeEl.remove(),t.children().length||this.unsetParent(t.parent()),this.restoreItemAtIndex(i,s),void this.reset()}this.placeEl.replaceWith(i),this.hasNewRoot?(!0===this.options.fixed?this.restoreItemAtIndex(i,s):this.el.trigger("lostItem"),this.dragRootEl.trigger("gainedItem")):this.dragRootEl.trigger("change"),this.options.callback.call(this,this.dragRootEl,i,e),this.reset()},dragMove:function(t){var e,s=this.options,i=this.mouse;this.dragEl.css({left:t.pageX-i.offsetX,top:t.pageY-i.offsetY}),i.lastX=i.nowX,i.lastY=i.nowY,i.nowX=t.pageX,i.nowY=t.pageY,i.distX=i.nowX-i.lastX,i.distY=i.nowY-i.lastY,i.lastDirX=i.dirX,i.lastDirY=i.dirY,i.dirX=0===i.distX?0:0<i.distX?1:-1,i.dirY=0===i.distY?0:0<i.distY?1:-1;var o,n=Math.abs(i.distX)>Math.abs(i.distY)?1:0;if(!i.moving)return i.dirAx=n,void(i.moving=!0);s.scroll&&(void 0!==h.jQuery.fn.scrollParent?(l=!1,(o=this.el.scrollParent()[0])!==c&&"HTML"!==o.tagName?(s.scrollTriggers.bottom+o.offsetHeight-t.pageY<s.scrollSensitivity?o.scrollTop=l=o.scrollTop+s.scrollSpeed:t.pageY-s.scrollTriggers.top<s.scrollSensitivity&&(o.scrollTop=l=o.scrollTop-s.scrollSpeed),s.scrollTriggers.right+o.offsetWidth-t.pageX<s.scrollSensitivity?o.scrollLeft=l=o.scrollLeft+s.scrollSpeed:t.pageX-s.scrollTriggers.left<s.scrollSensitivity&&(o.scrollLeft=l=o.scrollLeft-s.scrollSpeed)):(t.pageY-d(c).scrollTop()<s.scrollSensitivity?l=d(c).scrollTop(d(c).scrollTop()-s.scrollSpeed):d(h).height()-(t.pageY-d(c).scrollTop())<s.scrollSensitivity&&(l=d(c).scrollTop(d(c).scrollTop()+s.scrollSpeed)),t.pageX-d(c).scrollLeft()<s.scrollSensitivity?l=d(c).scrollLeft(d(c).scrollLeft()-s.scrollSpeed):d(h).width()-(t.pageX-d(c).scrollLeft())<s.scrollSensitivity&&(l=d(c).scrollLeft(d(c).scrollLeft()+s.scrollSpeed)))):console.warn("To use scrolling you need to have scrollParent() function, check documentation for more information")),this.scrollTimer&&clearTimeout(this.scrollTimer),s.scroll&&l&&(this.scrollTimer=setTimeout(function(){d(h).trigger(t)},10)),i.dirAx!==n?(i.distAxX=0,i.distAxY=0):(i.distAxX+=Math.abs(i.distX),0!==i.dirX&&i.dirX!==i.lastDirX&&(i.distAxX=0),i.distAxY+=Math.abs(i.distY),0!==i.dirY&&i.dirY!==i.lastDirY&&(i.distAxY=0)),i.dirAx=n,i.dirAx&&i.distAxX>=s.threshold&&(i.distAxX=0,r=this.placeEl.prev(s.itemNodeName),0<i.distX&&r.length&&!r.hasClass(s.collapsedClass)&&!r.hasClass(s.noChildrenClass)&&(e=r.find(s.listNodeName).last(),this.placeEl.parents(s.listNodeName).length+this.dragDepth<=s.maxDepth&&(e.length?(e=r.children(s.listNodeName).last()).append(this.placeEl):this.createSubLevel(r,this.placeEl))),i.distX<0&&(this.placeEl.next(s.itemNodeName).length||(a=this.placeEl.parent(),this.placeEl.closest(s.itemNodeName).after(this.placeEl),a.children().length||this.unsetParent(a.parent()))));var l=!1;if(p||(this.dragEl[0].style.visibility="hidden"),this.pointEl=d(c.elementFromPoint(t.pageX-c.body.scrollLeft,t.pageY-(h.pageYOffset||c.documentElement.scrollTop))),p||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(s.handleClass)&&(this.pointEl=this.pointEl.closest(s.itemNodeName)),this.pointEl.hasClass(s.emptyClass))l=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(s.itemClass))return;var a,n=this.pointEl.closest("."+s.rootClass),r=this.dragRootEl.data("nestable-id")!==n.data("nestable-id");i.dirAx&&!r&&!l||r&&s.group!==n.data("nestable-group")||this.options.fixedDepth&&this.dragDepth+1!==this.pointEl.parents(s.listNodeName).length||this.dragDepth-1+this.pointEl.parents(s.listNodeName).length>s.maxDepth||(i=t.pageY<this.pointEl.offset().top+this.pointEl.height()/2,a=this.placeEl.parent(),l?((e=d(c.createElement(s.listNodeName)).addClass(s.listClass)).append(this.placeEl),this.pointEl.replaceWith(e)):i?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),a.children().length||this.unsetParent(a.parent()),this.dragRootEl.find(s.itemNodeName).length||this.appendEmptyElement(this.dragRootEl),this.dragRootEl=n,r&&(this.hasNewRoot=this.el[0]!==this.dragRootEl[0]))},appendEmptyElement:function(t){t.append('<div class="'+this.options.emptyClass+'"/>')}},d.fn.nestable=function(i){var o=this,n=arguments;return"Nestable"in h||(h.Nestable={},Nestable.counter=0),this.each(function(){var t=d(this).data("nestable");if(t){if("string"==typeof i&&"function"==typeof t[i])if(1<n.length){for(var e=[],s=1;s<n.length;s++)e.push(n[s]);o=t[i].apply(t,e)}else o=t[i]()}else Nestable.counter++,d(this).data("nestable",new l(this,i)),d(this).data("nestable-id",Nestable.counter)}),o||this}}(window.jQuery||window.Zepto,window,document);
